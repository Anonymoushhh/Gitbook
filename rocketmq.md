##场景
&emsp;&emsp;现在系统流行微服务架构，假设购买商品时需要有两个操作，分别是扣库存和记录购买行为。然而扣库存操作的商品表在商品系统中，记录购买行为的订单表在订单系统中，两个系统数据库分离。为了保证服务的可靠性，我们要确保这两个操作为一个事务，要么都成功，要么都失败。在分布式环境下，根据CAP理论，我们总要舍弃点什么。在这种情况下，P（Partition tolerance）往往是不可避免的，因为网络问题总是不稳定的。因此可以认为 CAP 的 P 总是成立，而CAP 定理告诉我们，剩下的 C（Consistency）和 A（vailability） 无法同时做到。
##分析
&emsp;&emsp;在分布式环境中，我们需要保证的是一致性，而抛弃可用性。而一致性又分为强一致性，弱一致性和最终一致性。保证强一致性往往需要付出惨重的代价，比如系统运行缓慢，甚至死锁，因此我们有些情况下只需保证事务的最终一致性即可。
##方案
&emsp;&emsp;A（存在DB操作）、B（存在DB操作）两方需要保证分布式事务一致性，通过引入中间层MQ，A和MQ保持事务一致性（异常情况下通过MQ反查A接口实现check），B和MQ保证事务一致（通过重试），从而达到最终事务一致性。其中的原理就是：大事务 = 小事务 + 异步。
![](/assets/未命名文件.png)
&emsp;&emsp;